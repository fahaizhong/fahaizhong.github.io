<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>

<body>
  <div id="container"></div>
  <script src="d3.v6.min.js"></script>
  <script type="text/javascript" src="stardust.bundle.min.js"></script>
  <script src="stardustutils.js" type="text/javascript"></script>
  <script src="tfdp.js" type="text/javascript"></script>
  <select name="pets" id="pet-select" oninput="runSelect()">
    <option value="">--Please choose an option--</option>
    <option value="VisCoAuthor_4">VisCoAuthor_4</option>
    <option value="VisCoAuthor_5">VisCoAuthor_5</option>
    <option value="VisCoAuthor_7">VisCoAuthor_7</option>
    <option value="VisCoAuthor_8">VisCoAuthor_8</option>
    <option value="VisCoAuthor_9">VisCoAuthor_9</option>
    <option value="VisCoAuthor_10">VisCoAuthor_10</option>
    <option value="sampledata/sample_100">sample_100</option>
    <option value="sampledata/sample_102">sample_102</option>
    <option value="sampledata/sample_0">sample_0</option>
    <option value="sampledata/sample_1">sample_1</option>
    <option value="sampledata/sample_5">sample_5</option>
    <option value="sampledata/sample_9">sample_9</option>
    <option value="sampledata/sample_10">sample_10</option>
    <option value="sampledata/sample_18">sample_18</option>
    <option value="sampledata/sample_19">sample_19</option>
    <option value="sampledata/sample_20">sample_20</option>
    <option value="sampledata/sample_21">sample_21</option>
    <option value="sampledata/sample_22">sample_22</option>
    <!-- <option value="goldfish">VisCoAuthor_5</option> -->
  </select>
  <div class="sliders"></div>
  <canvas id="main-canvas"></canvas>



  <style type="text/css">
    .fps {
      position: fixed;
      top: 0;
      right: 0;
      padding: 10px;
      margin: 0;
      font-size: 15px;
    }

    select {
      /* position: absolute; */
      left: 0px;
      width: 240px;
      margin-top: 10;
      bottom: 0;
    }

    .sliders {
      /* position: absolute; */
      left: 0px;
      width: 640px;
      padding-top: 10px;
      bottom: 0;
    }

    .sliders label {
      display: inline-block;
      font-weight: bold;
      white-space: pre;
    }

    .sliders input {
      display: inline-block;
      margin: 5px 0;
    }

    .sliders input[type=number] {
      display: inline-block;
      width: 50px;
      margin: 5px 0;
    }
  </style>
  <script>
    function runSelect() {
      const elem = event.target;
      // console.log();
      alpha = 1.00;
      iter = 0;
      // console.log();
      RunSimulation(elem.value);
    }
    const width = 800;
    const height = 800;
    var data = [];
    var nodes = [];
    var links = [];
    var counts = [];
    var timer = d3.timer;
    var cnt = 0;
    var maxiter = 400;
    var K = 2,
      p = 2.0,
      yScaleFactorAttr = 0.0,
      xScaleFactorAttr = 1.0,
      DegreeAttr = 1.0;
    var yScaleFactorRep = 40.0,
      xScaleFactorRep = 1.0,
      DegreeRep = 2.0;
    var fileid = 9;
    var lr = 20.0;


    var renderScale = 1.0;
    var repulforce = tfdp().strength(-1);
    var stepper1;
    var iter = 0;
    var alpha = 1.0;
    var colors = [
      [31, 119, 180],
      [255, 127, 14],
      [44, 160, 44],
      [214, 39, 40],
      [148, 103, 189],
      [140, 86, 75],
      [227, 119, 194],
      [127, 127, 127],
      [188, 189, 34],
      [23, 190, 207],
      [127, 103, 39],
      [220, 20, 60],
      [250, 128, 114],
      [255, 0, 255],
      [255, 228, 181],
      [255, 215, 0],
      [0, 128, 114],
      [112, 128, 144],
      [30, 144, 255],
      [128, 70, 0],
    ];
    colors = colors.map(x => [x[0] / 255, x[1] / 255, x[2] / 255, 1]);
    var canvas = document.getElementById("main-canvas");
    var platform = Stardust.platform("webgl-2d", canvas, width, height);
    var snodes = Stardust.mark.create(Stardust.mark.circle(10), platform);
    var sedges = Stardust.mark.create(Stardust.mark.line(), platform);
    var positions;
    function makeSlider(name, attr, min, max, defaultValue) {
      var d = defaultValue;

      var sliderinput = d3.select(".sliders").append("input");
      sliderinput
        .attr("type", "number")
        .attr("step", 0.1)
        .attr("value", d);

      sliderinput.on("input", () => {
        var val = +sliderinput.property("value");

        var d = val;
        if (attr == "a1") {
          yScaleFactorAttr = d * 20;
          alpha = 0.1;

          stepper1.restart(step);
          iter = maxiter / 2;
        }
        if (attr == "a2") {
          yScaleFactorRep = d * 20;
          alpha = 0.1;
          stepper1.restart(step);
          iter = maxiter / 2;
        }
        document.getElementById("label" + attr).innerHTML = " " + attr + " = " + d.toFixed(3) + ", ";
      });

      d3.select(".sliders")
        .append("label")
        .attr("id", "label" + attr)
        .text(" " + attr + " = " + d.toFixed(3) + ", ");
      d3.select(".sliders")
        .append("label")
        .text(name);
      d3.select(".sliders")
        .append("br");
    }


    makeSlider("Short Range Attractive Force Ratio", "a1", 0, 10, 0);
    makeSlider("Short Range Repulsive Force Ratio", "a2", 0, 10, 2);


    async function RunSimulation(filename) {
      let data = await d3.json(`https://fahaizhong.github.io/data/${filename}.json`);
      data_var = data;
      nodes = data.nodes;
      nodes.map(d => (d.id = d.name));
      for (var i = 0; i < nodes.length; i++) {
        nodes[i].index = i;
      }
      links = data.links;
      // links.map(d => (d.source = nodes[d.source].id, d.target = nodes[d.target].id));
      links.map(d => (d.idsrc = d.source, d.idtgt = d.target));
      links.map(d => (d.source = nodes[d.idsrc], d.target = nodes[d.idtgt]));
      counts = nodes.map(d => 0);
      for (var i = 0; i < links.length; i++) {
        var link = links[i], src = link.idsrc, tgt = link.idtgt;
        if (src == tgt) continue;
        counts[src]++;
        counts[tgt]++;
      }
      var initialRadius = 10,
        initialAngle = Math.PI * (3 - Math.sqrt(5));
      for (var i = 0, n = nodes.length, node; i < n; ++i) {
        node = nodes[i], node.index = i;
        if (node.fx != null) node.x = node.fx;
        if (node.fy != null) node.y = node.fy;
        if (isNaN(node.x) || isNaN(node.y)) {
          var radius = initialRadius * Math.sqrt(i), angle = i * initialAngle;
          node.x = radius * Math.cos(angle);
          node.y = radius * Math.sin(angle);
        }
        if (isNaN(node.vx) || isNaN(node.vy)) {
          node.vx = node.vy = 0;
        }
      }

      var pos = nodes.map(d => [d.x, d.y]);
      var renderScale = 1.0;
      positions = Stardust.array("Vector2")
        .value(d => d)
        .data(pos);

      var positionScale = Stardust.scale.custom("array(pos, value)").attr("pos", "Vector2Array", positions);
      var positionScale = Stardust.scale.custom("array(pos, value)").attr("pos", "Vector2Array", positions);
      snodes.attr("radius", 7.5).attr("color", d => colors[d.group % 20]);
      snodes.attr("center", positionScale(d => d.index));
      sedges.attr("p1", positionScale(d => d.source.index));
      sedges.attr("p2", positionScale(d => d.target.index));
      sedges.attr("color", [192.0 / 256, 192.0 / 256, 192.0 / 256, 0.5]);
      snodes.data(nodes);
      sedges.data(links);
      Simulation();
    }
    RunSimulation("VisCoAuthor_9");

    var pos;
    function Simulation() {
      var i = 0;
      repulforce.initialize(nodes);
      alpha = 1.0;
      stepper1 = timer(step);
    }
    var debug = false;
    function eval() {
      var res = 0;
      var N = nodes.length, E = links.length;
      var nodeto = Array(N);
      for (var i = 0; i < N; i++) {
        nodeto[i] = [];
      }
      for (var i = 0; i < E; i++) {
        var link = links[i], src = link.idsrc, tgt = link.idtgt;
        if (src == tgt) continue;
        nodeto[src].push(tgt);
        nodeto[tgt].push(src);
      }

      for (var i = 0; i < N; i++) {
        var distnodes = [];
        for (var j = 0; j < N; j++) {
          if (j != i) {
            var mx = nodes[i].x - nodes[j].x;
            var my = nodes[i].y - nodes[j].y;
            distnodes.push({ id: j, distance: mx * mx + my * my });
          }
        }
        distnodes.sort(function (a, b) { return a.distance - b.distance });
        if (debug) console.log(nodeto[i], distnodes);
        var templen = nodeto[i].length;
        var GSet = new Set();
        if (templen <= 0) continue;
        for (var k = 0; k < templen; k++) {
          GSet.add(nodeto[i][k]);
        }
        var inSet = new Set();
        var USet = new Set();
        // console.log(distnodes);
        for (var k = 0; k < templen; k++) {
          USet.add(distnodes[k].id);
          if (GSet.has(distnodes[k].id)) {
            inSet.add(distnodes[k].id);
          }
        }
        res += 1.0 * inSet.size / USet.size;
      }
      return res / N;
    }

    function step() {

      SimulationStep(alpha);
      alpha += (0.01 - alpha) * 0.011446905343061142;
      alpha = Math.max(alpha, 0.01);
      if (iter >= maxiter) {
        stepper1.stop();
        console.log(fileid, iter, eval());;
      }
      iter += 1;
    }
    function render() {
      sedges.render();
      snodes.render();
    }
    function jiggle() {
      return (Math.random() - 0.5) * 1e-6;
    }

    function SimulationStep(alpha) {
      repulforce.xScaleFactor(xScaleFactorRep).yScaleFactor(yScaleFactorRep).Degree(DegreeRep);
      repulforce(alpha);
      var i = 0;
      for (i = 0, E = links.length; i < E; i++) {
        var link = links[i], source = link.source, target = link.target, src = link.idsrc, tgt = link.idtgt;
        var cntsrc = counts[src], cnttgt = counts[tgt];
        var strength = 1.0 / Math.min(cntsrc, cnttgt);
        var b = 1.0 * cnttgt / (cntsrc + cnttgt);
        x = target.x + target.vx - source.x - source.vx || jiggle();
        y = target.y + target.vy - source.y - source.vy || jiggle();
        var l = Math.sqrt(x * x + y * y);
        var r = yScaleFactorAttr / Math.pow((1 + xScaleFactorAttr * l * l), DegreeAttr) + K;
        r *= strength;
        source.vx += alpha * x * r * b;
        source.vy += alpha * y * r * b;
        b = 1 - b;
        target.vx -= alpha * x * r * b;
        target.vy -= alpha * y * r * b;
      }

      for (i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        node.vx *= 0.6;
        node.vy *= 0.6;
        node.x += node.vx;
        node.y += node.vy;
      }

      var xs = nodes.map(d => d.x);
      var ys = nodes.map(d => d.y);
      var minx = d3.min(xs);
      var miny = d3.min(ys);
      var maxx = d3.max(xs);
      var maxy = d3.max(ys);
      var midx = (minx + maxx) / 2;
      var midy = (miny + maxy) / 2;
      var scale = Math.max(maxy - miny, maxx - minx) * 1.05;
      renderScale = scale;

      pos = nodes.map(d => [(d.x - midx) / renderScale * width + width / 2, ((midy - d.y) / renderScale + (maxy - midy) / renderScale - 0.48) * height + height / 2]);

      positions.data(pos);
      requestAnimationFrame(render);
    }
  </script>
</body>

</html>