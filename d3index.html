<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>

<body>
  <select name="pets" id="pet-select" oninput="runSelect()">
    <option value="">--Please choose an option--</option>
    <option value="VisCoAuthor_4">VisCoAuthor_4</option>
    <option value="VisCoAuthor_5">VisCoAuthor_5</option>
    <option value="VisCoAuthor_7">VisCoAuthor_7</option>
    <option value="VisCoAuthor_8">VisCoAuthor_8</option>
    <option value="VisCoAuthor_9">VisCoAuthor_9</option>
    <option value="VisCoAuthor_10">VisCoAuthor_10</option>
    <option value="sampledata/sample_100">sample_100</option>
    <option value="sampledata/sample_102">sample_102</option>
    <option value="sampledata/sample_0">sample_0</option>
    <option value="sampledata/sample_1">sample_1</option>
    <option value="sampledata/sample_5">sample_5</option>
    <option value="sampledata/sample_9">sample_9</option>
    <option value="sampledata/sample_10">sample_10</option>
    <option value="sampledata/sample_18">sample_18</option>
    <option value="sampledata/sample_19">sample_19</option>
    <option value="sampledata/sample_20">sample_20</option>
    <option value="sampledata/sample_21">sample_21</option>
    <option value="sampledata/sample_22">sample_22</option>
    <!-- <option value="goldfish">VisCoAuthor_5</option> -->
  </select>

  <div id="container"></div>
  <script src="d3.v5.js"></script>
  <script type="text/javascript" src="stardust.bundle.min.js"></script>
  <script src="stardustutils.js" type="text/javascript"></script>

  <style type="text/css">
    .fps {
      position: fixed;
      top: 0;
      right: 0;
      padding: 10px;
      margin: 0;
      font-size: 15px;
    }

    select {
      /* position: absolute; */
      left: 0px;
      width: 240px;
      margin-top: 10;
      bottom: 0;
    }
  </style>
  <canvas id="main-canvas"></canvas>

  <div class="fps"></div>
  <div class="initializing">
    <p>Initializing...</p>
  </div>
  <script>
    function runSelect() {
      const elem = event.target;
      alpha = 1.00;
      iter = 0;
      RunSimulation(elem.value);
    }
    const width = 800;
    const height = 800;
    let data = [];
    let nodes = [];
    let links = [];
    function power_iteration(A, num_simulations) {
      var lens = A.length;
      var i = 0;
      var b_k = Array();
      for (i = 0; i < lens; i++) {
        b_k.push(Math.random());
      }

      var iter = 0;
      for (iter = 0; iter < num_simulations; iter++) {
        var norm_sum = 0;
        for (i = 0; i < lens; i++) {
          var temp = b_k[i] * A[i];
          norm_sum = norm_sum + temp * temp;
          b_k[i] = temp;
        }
        norm_sum = Math.sqrt(norm_sum);
        for (i = 0; i < lens; i++) {
          b_k[i] = b_k[i] / norm_sum;
        }
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    // var dsv = d3.dsv(" ", "text/plain");

    var data_var;
    var canvas = document.getElementById("main-canvas");
    var platform = Stardust.platform("webgl-2d", canvas, width, height);
    var snodes = Stardust.mark.create(Stardust.mark.circle(10), platform);
    var sedges = Stardust.mark.create(Stardust.mark.line(), platform);
    var positions;

    var simulation;
    var colors = [
      [31, 119, 180],
      [255, 127, 14],
      [44, 160, 44],
      [214, 39, 40],
      [148, 103, 189],
      [140, 86, 75],
      [227, 119, 194],
      [127, 127, 127],
      [188, 189, 34],
      [23, 190, 207],
      [127, 103, 39],
      [220, 20, 60],
      [250, 128, 114],
      [255, 0, 255],
      [255, 228, 181],
      [255, 215, 0],
      [0, 128, 114],
      [112, 128, 144],
      [30, 144, 255],
      [128, 70, 0],
    ];
    colors = colors.map(x => [x[0] / 255, x[1] / 255, x[2] / 255, 1]);
    var ans = [];
    const svg = d3.select('body').append('svg')
      .attr("viewBox", [0, 0, width, height]);
    var linkdraw;
    var nodedraw;
    var pos;
    async function RunSimulation(filename) {
      await new Promise((resolve) => {
        d3.json(`http://127.0.0.1:5500/${filename}.json`).then(function (data) {
          console.log("complete", data.length);
          data_var = data;
          nodes = data.nodes;
          nodes.map(d => (d.id = d.name));
          for (var i = 0; i < nodes.length; i++) {
            nodes[i].index = i;
          }
          links = data.links;
          links.map(d => (d.idsrc = d.source, d.idtgt = d.target));
          links.map(d => (d.source = nodes[d.idsrc], d.target = nodes[d.idtgt]));
          counts = nodes.map(d => 0);
          for (var i = 0; i < links.length; i++) {
            var link = links[i], src = link.idsrc, tgt = link.idtgt;
            if (src == tgt) continue;
            counts[src]++;
            counts[tgt]++;
          }
          var N = nodes.length;
          if (filename == "sampledata/sample_102") {
            simulation = d3
              .forceSimulation(nodes)
              .force(
                "link",
                d3
                  .forceLink(links)
                  .id((d) => d.id)
                  .distance(0)
                // .strength(0.05)
              )
              .force("charge", d3.forceManyBody().strength(-100))
            // case sample_102 gets results like slides with this parameter
          }
          else {
            simulation = d3
              .forceSimulation(nodes)
              .force(
                "link",
                d3
                  .forceLink(links)
                  .id((d) => d.id)
                  .distance(0)
                  .strength(0.05)
              )
              .force("charge", d3.forceManyBody().strength(-100))
          }

          // .force("x", d3.forceX().strength(0.02))
          // .force("y", d3.forceY().strength(0.02));

          var pos = nodes.map(d => [d.x, d.y]);
          var renderScale = 1.0;
          positions = Stardust.array("Vector2")
            .value(d => d)
            .data(pos);

          var positionScale = Stardust.scale.custom("array(pos, value)").attr("pos", "Vector2Array", positions);
          var positionScale = Stardust.scale.custom("array(pos, value)").attr("pos", "Vector2Array", positions);
          snodes.attr("radius", 7.5).attr("color", d => colors[parseInt(d.group) % 20]);
          snodes.attr("center", positionScale(d => d.index));
          sedges.attr("p1", positionScale(d => d.source.index));
          sedges.attr("p2", positionScale(d => d.target.index));
          sedges.attr("color", [192.0 / 256, 192.0 / 256, 192.0 / 256, 0.5]);
          snodes.data(nodes);
          sedges.data(links);

          let count = 0
          var fps = new FPS();
          simulation.on("tick", () => {
            count = count + 1;
            console.log(count);
            var xs = nodes.map(d => d.x);
            var ys = nodes.map(d => d.y);
            var minx = d3.min(xs);
            var miny = d3.min(ys);
            var maxx = d3.max(xs);
            var maxy = d3.max(ys);
            var midx = (minx + maxx) / 2;
            var midy = (miny + maxy) / 2;
            var scale = Math.max(maxy - miny, maxx - minx) * 1.05;
            renderScale = scale;
            pos = nodes.map(d => [(d.x - midx) / renderScale * width + width / 2, ((midy - d.y) / renderScale + (maxy - midy) / renderScale - 0.48) * height + height / 2]);
            positions.data(pos);
            requestAnimationFrame(render);
          });

          simulation.on('end', resolve);

          function render() {

            sedges.render();
            snodes.render();

            fps.update();
          }
          function finalize() {
            force.stop();
          }

        })
      })
      var evalres = eval();
      console.log(evalres);
      ans.push(evalres);
    }
    RunSimulation("VisCoAuthor_9");

    var debug = false;
    function eval() {
      var res = 0;
      var N = nodes.length, E = links.length;
      var nodeto = Array(N);
      for (var i = 0; i < N; i++) {
        nodeto[i] = [];
      }
      for (var i = 0; i < E; i++) {
        var link = links[i], src = link.idsrc, tgt = link.idtgt;
        if (src == tgt) continue;
        nodeto[src].push(tgt);
        nodeto[tgt].push(src);
      }

      for (var i = 0; i < N; i++) {
        var distnodes = [];
        for (var j = 0; j < N; j++) {
          if (j != i) {
            // var distnode;

            var mx = nodes[i].x - nodes[j].x;
            var my = nodes[i].y - nodes[j].y;
            // distnode = ;
            distnodes.push({ id: j, distance: mx * mx + my * my });
          }
        }
        distnodes.sort(function (a, b) { return a.distance - b.distance });
        if (debug) console.log(nodeto[i], distnodes);
        var templen = nodeto[i].length;
        if (templen <= 0) continue;
        var GSet = new Set();
        for (var k = 0; k < templen; k++) {
          GSet.add(nodeto[i][k]);
        }
        var inSet = new Set();
        var USet = new Set();
        // console.log(distnodes);
        for (var k = 0; k < templen; k++) {
          USet.add(distnodes[k].id);
          if (GSet.has(distnodes[k].id)) {
            inSet.add(distnodes[k].id);
          }
        }
        res += 1.0 * inSet.size / USet.size;
      }
      return res / N;
    }


  </script>
</body>

</html>